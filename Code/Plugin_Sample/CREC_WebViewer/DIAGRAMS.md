# CREC Web Viewer アーキテクチャ図解

このファイルには、CREC Web Viewerの構造を視覚的に説明する図が含まれています。

## 図1: システム全体図

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                    CREC Web Viewer システム                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        [ユーザー]
           │
           │ ① 検索リクエスト
           ↓
    ┌──────────────┐
    │   ブラウザ    │ ← あなたが操作する画面
    │ (Chrome等)    │
    └───────┬──────┘
            │
            │ ② HTTP通信
            │   (JSON形式)
            ↓
    ┌──────────────────────────────────┐
    │      CREC_WebViewer.exe          │
    │                                  │
    │  ┌────────────────────────┐    │
    │  │    フロントエンド       │    │ ← HTML/CSS/JavaScript
    │  │  (wwwroot/)            │    │
    │  │  ・index.html          │    │
    │  │  ・app.js              │    │
    │  └───────┬────────────────┘    │
    │          │                      │
    │          │ ③ APIコール          │
    │          ↓                      │
    │  ┌────────────────────────┐    │
    │  │   バックエンド          │    │ ← ASP.NET Core
    │  │  (Controllers/Services) │    │
    │  │  ・ApiController.cs     │    │
    │  │  ・CrecDataService.cs   │    │
    │  └───────┬────────────────┘    │
    │          │                      │
    │          │ ④ ファイル読み込み   │
    │          ↓                      │
    └──────────────────────────────────┘
            │
            │ ⑤ データアクセス
            ↓
    ┌──────────────┐
    │  CRECデータ   │ ← index.txt, comment.txt等
    │  フォルダ     │
    └──────────────┘
```

## 図2: データフロー（検索の例）

```
時系列: ① → ② → ③ → ④ → ⑤ → ⑥

┌─────────┐                    ┌─────────┐
│         │ ①「電子部品」入力   │         │
│ ユーザー │ ──────────────→  │ブラウザ │
│         │                    │(UI)     │
└─────────┘                    └────┬────┘
                                    │
                               ② JavaScriptがAPIコール
                                    │ fetch('/api/collections/search?...')
                                    ↓
                              ┌─────────────┐
                              │ ASP.NET Core│
                              │ Web Server  │
                              └──────┬──────┘
                                     │
                              ③ ルーティング
                                     │ ApiController.Search()
                                     ↓
                              ┌──────────────┐
                              │ Controller   │
                              │ (リクエスト  │
                              │  処理)       │
                              └──────┬───────┘
                                     │
                              ④ サービス呼び出し
                                     │ CrecDataService.SearchCollectionsAsync()
                                     ↓
                              ┌──────────────┐
                              │ Service      │
                              │ (ビジネス    │
                              │  ロジック)   │
                              └──────┬───────┘
                                     │
                              ⑤ ファイルI/O
                                     │ File.ReadAllLinesAsync()
                                     ↓
                              ┌──────────────┐
                              │ SAMPLE001/   │
                              │  index.txt   │
                              │ SAMPLE002/   │
                              │  index.txt   │
                              │ SAMPLE003/   │
                              │  index.txt   │
                              └──────┬───────┘
                                     │
                              ⑥ データ返却（逆順）
                                     │
    ┌────────────────────────────────┤
    │                                │
    ↓ JSON                           ↓ オブジェクト
┌─────────────┐              ┌──────────────┐
│ ブラウザ     │ ←JSON形式─── │ Controller   │
│ (結果表示)  │              │ (JSON変換)   │
└─────────────┘              └──────────────┘
```

## 図3: ファイル構成と役割

```
CREC_WebViewer/
│
├─┬─ wwwroot/                      [フロントエンド領域]
│ ├── index.html                   画面レイアウト
│ │   ┌─────────────────────────┐
│ │   │ <検索フィルタ>            │
│ │   │ <結果表示エリア>          │
│ │   │ <詳細モーダル>            │
│ │   └─────────────────────────┘
│ │
│ └── app.js                       画面の動き
│     ┌─────────────────────────┐
│     │ searchCollections()       │ ← 検索処理
│     │ displaySearchResults()    │ ← 表示処理
│     │ showCollectionDetails()   │ ← 詳細表示
│     └─────────────────────────┘
│
├─┬─ Controllers/                  [APIエンドポイント]
│ └── ApiController.cs
│     ┌─────────────────────────┐
│     │ GET /api/collections     │ ← 全件取得
│     │ GET /api/collections/    │
│     │     search               │ ← 検索
│     │ GET /api/collections/{id}│ ← 詳細取得
│     │ GET /api/files/{id}/     │
│     │     {filename}           │ ← ファイル取得
│     └─────────────────────────┘
│
├─┬─ Services/                     [ビジネスロジック]
│ └── CrecDataService.cs
│     ┌─────────────────────────┐
│     │ GetAllCollectionsAsync() │ ← データ読み込み
│     │ SearchCollectionsAsync() │ ← 検索処理
│     │ GetCollectionByIdAsync() │ ← ID検索
│     └─────────────────────────┘
│
├─┬─ Models/                       [データ定義]
│ └── CollectionData.cs
│     ┌─────────────────────────┐
│     │ class CollectionData {   │
│     │   CollectionID          │
│     │   CollectionName        │
│     │   CollectionCategory    │
│     │   CollectionTag1/2/3    │
│     │   ...                   │
│     │ }                        │
│     └─────────────────────────┘
│
└── Program.cs                     [アプリ起動設定]
    ┌─────────────────────────┐
    │ builder.Services...      │ ← サービス登録
    │ app.UseStaticFiles()     │ ← 静的ファイル配信
    │ app.MapControllers()     │ ← ルーティング設定
    │ app.Run()                │ ← サーバー起動
    └─────────────────────────┘
```

## 図4: HTTPリクエスト/レスポンスの詳細

```
【リクエスト】
┌──────────────────────────────────────────────┐
│ GET /api/collections/search?searchText=電子部品 │
│ HTTP/1.1                                     │
│                                              │
│ Host: localhost:5000                         │
│ Accept: application/json                     │
│ User-Agent: Mozilla/5.0 ...                  │
└──────────────────────────────────────────────┘
        │
        │ インターネット/ネットワーク
        ↓
┌──────────────────────────────────────────────┐
│ ASP.NET Core Web Server                      │
│  ↓                                           │
│ ルーティング: /api/collections/search        │
│  ↓                                           │
│ コントローラー: CollectionsController.Search()│
│  ↓                                           │
│ サービス: CrecDataService.SearchCollections()│
│  ↓                                           │
│ ファイル読み込み & 検索処理                   │
└──────────────────────────────────────────────┘
        │
        │ 処理結果
        ↓
【レスポンス】
┌──────────────────────────────────────────────┐
│ HTTP/1.1 200 OK                              │
│ Content-Type: application/json               │
│ Content-Length: 1234                         │
│                                              │
│ {                                            │
│   "collections": [                           │
│     {                                        │
│       "collectionID": "SAMPLE001",           │
│       "collectionName": "電子部品サンプル",   │
│       "collectionCategory": "電子部品",       │
│       "collectionTag1": "Arduino",           │
│       "collectionCurrentInventory": 25,      │
│       ...                                    │
│     }                                        │
│   ],                                         │
│   "totalCount": 1,                           │
│   "page": 1,                                 │
│   "pageSize": 20                             │
│ }                                            │
└──────────────────────────────────────────────┘
```

## 図5: データ読み込みプロセス

```
Environment.CurrentDirectory = "/path/to/crec/data"

Directory.GetDirectories()
    │
    ├─→ SAMPLE001/
    │   ├── index.txt          ← これを読む！
    │   │   ┌─────────────────────────────┐
    │   │   │ CollectionName,電子部品サンプル│
    │   │   │ CollectionMC,ELEC-001        │
    │   │   │ CollectionCategory,電子部品   │
    │   │   │ CollectionTag1,Arduino       │
    │   │   │ ...                          │
    │   │   └─────────────────────────────┘
    │   ├── comment.txt        ← コメント読む
    │   └── [画像ファイル等]
    │
    ├─→ SAMPLE002/
    │   ├── index.txt
    │   └── ...
    │
    └─→ SAMPLE003/
        ├── index.txt
        └── ...

    ↓ 全フォルダをスキャン

┌──────────────────────────────┐
│ List<CollectionData>         │
│                              │
│ [0] SAMPLE001のデータ        │
│ [1] SAMPLE002のデータ        │
│ [2] SAMPLE003のデータ        │
│                              │
└──────────────────────────────┘
    │
    ↓ メモリ上に保存（キャッシュ）
    │
┌──────────────────────────────┐
│ _collectionsCache            │
│ (5分間有効)                   │
└──────────────────────────────┘
```

## 図6: セキュリティ対策

```
【安全なファイルアクセス】

リクエスト: GET /api/files/SAMPLE001/image.jpg
    │
    ↓ 検証ステップ
┌─────────────────────────────────────┐
│ 1. ファイル名チェック                │
│    ✓ ".." が含まれていないか？        │
│    ✓ "/" が含まれていないか？         │
│    ✓ "\\" が含まれていないか？        │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 2. パス構築                          │
│    dataFolder = "/path/to/crec/data" │
│    collectionFolder = dataFolder +   │
│                       "/SAMPLE001"   │
│    filePath = collectionFolder +     │
│               "/image.jpg"           │
│    = "/path/to/crec/data/SAMPLE001/  │
│       image.jpg"                     │
└─────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────┐
│ 3. パス検証                          │
│    filePath が collectionFolder 内か？│
│    ✓ はい → OK                       │
│    ✗ いいえ → ブロック               │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 4. ファイル読み込み                  │
│    File.ReadAllBytes(filePath)       │
└─────────────────────────────────────┘


【危険なアクセスの例】

リクエスト: GET /api/files/../../../etc/passwd
    │
    ↓
┌─────────────────────────────────────┐
│ ファイル名に ".." が含まれる         │
│ → BadRequest("Invalid file name")   │
│ → ブロック！                         │
└─────────────────────────────────────┘
    │
    ✗ アクセス拒否
```

## 図7: キャッシュメカニズム

```
タイムライン:

00:00 ┌──────────────────────────────────┐
      │ 初回アクセス                      │
      │ ・ファイルから読み込み（遅い）    │
      │ ・キャッシュに保存                │
      │ ・lastUpdate = 00:00              │
      └──────────────────────────────────┘

00:01 ┌──────────────────────────────────┐
      │ 2回目のアクセス                   │
      │ ・キャッシュチェック: 有効期限内  │
      │ ・キャッシュから返す（速い！）    │
      └──────────────────────────────────┘

00:05 ┌──────────────────────────────────┐
      │ 5分後のアクセス                   │
      │ ・キャッシュチェック: 期限切れ    │
      │ ・ファイルから再読み込み          │
      │ ・キャッシュ更新                  │
      │ ・lastUpdate = 00:05              │
      └──────────────────────────────────┘


コードフロー:
┌────────────────────────────────────────┐
│ GetAllCollectionsAsync()               │
│   ↓                                    │
│ if (キャッシュあり && 有効期限内)      │
│   ├─ YES → キャッシュから返す (0.01秒)│
│   │                                    │
│   └─ NO  → ファイル読み込み (1秒)     │
│            ↓                           │
│            キャッシュに保存            │
│            ↓                           │
│            データを返す                │
└────────────────────────────────────────┘

メモリイメージ:
┌────────────────────────────────────────┐
│ CrecDataService クラス                 │
│                                        │
│ _collectionsCache: List<CollectionData>│
│   [SAMPLE001のデータ]                  │
│   [SAMPLE002のデータ]                  │
│   [SAMPLE003のデータ]                  │
│                                        │
│ _lastCacheUpdate: 2025-09-30 10:00:00 │
│                                        │
│ _cacheExpiry: 5分                      │
└────────────────────────────────────────┘
```

## 図8: 実行環境とポート

```
あなたのPC (Windows/Linux/Mac)
┌──────────────────────────────────────┐
│                                      │
│  ┌────────────────────────────┐    │
│  │ CREC_WebViewer.exe         │    │
│  │ (ASP.NET Core Server)      │    │
│  │                            │    │
│  │ ポート: 5000 (HTTP)        │←───┼─── ブラウザからアクセス
│  │ ポート: 5001 (HTTPS)       │    │    http://localhost:5000
│  └────────────────────────────┘    │
│                                      │
│  データフォルダ:                     │
│  C:\Users\...\CREC\Project\Data      │
│  (または Linux/Mac のパス)           │
│                                      │
└──────────────────────────────────────┘
         ↑
         │ ネットワーク経由でアクセス可能
         │ http://192.168.1.100:5000
         │
    ┌────┴────┐
    │ 他のPC  │
    │ (同じ   │
    │ ネット  │
    │ ワーク) │
    └─────────┘
```

---

これらの図を参考に、CREC Web Viewerの構造と動作を理解してください！
