# CREC Web Viewer アーキテクチャ図解

このファイルには、CREC Web Viewerの構造を視覚的に説明する図が含まれています。

## 図1: システム全体図

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                    CREC Web Viewer システム                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        [ユーザー]
           │
           │ ① 検索リクエスト
           ↓
    ┌──────────────┐
    │   ブラウザ    │ ← あなたが操作する画面
    │ (Chrome等)    │
    └───────┬──────┘
            │
            │ ② HTTP通信
            │   (JSON形式)
            ↓
    ┌──────────────────────────────────┐
    │      CREC_WebViewer.exe          │
    │                                  │
    │  ┌────────────────────────┐    │
    │  │    フロントエンド       │    │ ← HTML/CSS/JavaScript
    │  │  (wwwroot/)            │    │
    │  │  ・index.html          │    │
    │  │  ・app.js              │    │
    │  └───────┬────────────────┘    │
    │          │                      │
    │          │ ③ APIコール          │
    │          ↓                      │
    │  ┌────────────────────────┐    │
    │  │   バックエンド          │    │ ← ASP.NET Core
    │  │  (Controllers/Services) │    │
    │  │  ・ApiController.cs     │    │
    │  │  ・CrecDataService.cs   │    │
    │  └───────┬────────────────┘    │
    │          │                      │
    │          │ ④ ファイル読み込み   │
    │          ↓                      │
    └──────────────────────────────────┘
            │
            │ ⑤ データアクセス
            ↓
    ┌──────────────┐
    │  CRECデータ   │ ← index.txt, comment.txt等
    │  フォルダ     │
    └──────────────┘
```

## 図2: データフロー（検索の例）

```
時系列: ① → ② → ③ → ④ → ⑤ → ⑥

┌─────────┐                    ┌─────────┐
│         │ ①「電子部品」入力   │         │
│ ユーザー │ ──────────────→  │ブラウザ │
│         │                    │(UI)     │
└─────────┘                    └────┬────┘
                                    │
                               ② JavaScriptがAPIコール
                                    │ fetch('/api/collections/search?...')
                                    ↓
                              ┌─────────────┐
                              │ ASP.NET Core│
                              │ Web Server  │
                              └──────┬──────┘
                                     │
                              ③ ルーティング
                                     │ ApiController.Search()
                                     ↓
                              ┌──────────────┐
                              │ Controller   │
                              │ (リクエスト  │
                              │  処理)       │
                              └──────┬───────┘
                                     │
                              ④ サービス呼び出し
                                     │ CrecDataService.SearchCollectionsAsync()
                                     ↓
                              ┌──────────────┐
                              │ Service      │
                              │ (ビジネス    │
                              │  ロジック)   │
                              └──────┬───────┘
                                     │
                              ⑤ ファイルI/O
                                     │ File.ReadAllLinesAsync()
                                     ↓
                              ┌──────────────┐
                              │ {dataPath}/  │
                              │  SAMPLE001/  │
                              │   index.txt  │
                              │  SAMPLE002/  │
                              │   index.txt  │
                              │  SAMPLE003/  │
                              │   index.txt  │
                              └──────┬───────┘
                                     │
                              ⑥ データ返却（逆順）
                                     │
    ┌────────────────────────────────┤
    │                                │
    ↓ JSON                           ↓ オブジェクト
┌─────────────┐              ┌──────────────┐
│ ブラウザ     │ ←JSON形式─── │ Controller   │
│ (結果表示)  │              │ (JSON変換)   │
└─────────────┘              └──────────────┘
```

## 図3: ファイル構成と役割

```
CREC_WebViewer/
│
├─┬─ wwwroot/                      [フロントエンド領域]
│ ├── index.html                   画面レイアウト
│ │   ┌─────────────────────────┐
│ │   │ <検索フィルタ>            │
│ │   │ <結果表示エリア>          │
│ │   │ <詳細モーダル>            │
│ │   └─────────────────────────┘
│ │
│ └── app.js                       画面の動き
│     ┌─────────────────────────┐
│     │ searchCollections()       │ ← 検索処理
│     │ displaySearchResults()    │ ← 表示処理
│     │ showCollectionDetails()   │ ← 詳細表示
│     └─────────────────────────┘
│
├─┬─ Controllers/                  [APIエンドポイント]
│ ├── ApiController.cs
│ │   ┌─────────────────────────┐
│ │   │ GET /api/collections     │ ← 全件取得
│ │   │ GET /api/collections/    │
│ │   │     search               │ ← 検索
│ │   │ GET /api/collections/{id}│ ← 詳細取得
│ │   │ GET /api/thumbnail/{id}  │ ← サムネイル取得
│ │   └─────────────────────────┘
│ │
│ ├── FileController.cs
│ │   ┌─────────────────────────┐
│ │   │ GET /api/File/{id}/      │
│ │   │     {filename}           │ ← 画像ファイル取得
│ │   │ GET /api/File/data/{id}/ │
│ │   │     {filename}           │ ← データファイル取得
│ │   └─────────────────────────┘
│ │
│ └── ProjectSettingsController.cs
│     ┌─────────────────────────┐
│     │ GET /api/project-settings│ ← プロジェクト設定取得
│     └─────────────────────────┘
│
├─┬─ Services/                     [ビジネスロジック]
│ ├── CrecDataService.cs
│ │   ┌─────────────────────────┐
│ │   │ GetAllCollectionsAsync() │ ← データ読み込み
│ │   │ SearchCollectionsAsync() │ ← 検索処理
│ │   │ GetCollectionByIdAsync() │ ← ID検索
│ │   │ LoadFileList()          │ ← ファイルリスト取得
│ │   │                          │   (画像/データファイル)
│ │   └─────────────────────────┘
│ │
│ └── ProjectSettingsService.cs
│     ┌─────────────────────────┐
│     │ GetProjectSettingsAsync()│ ← .crecファイル読み込み
│     │                          │   (カスタムフィールドラベル)
│     └─────────────────────────┘
│
├─┬─ Models/                       [データ定義]
│ └── CollectionData.cs
│     ┌─────────────────────────┐
│     │ class CollectionData {   │
│     │   CollectionID          │
│     │   CollectionName        │
│     │   CollectionCategory    │
│     │   CollectionTag1/2/3    │
│     │   ...                   │
│     │ }                        │
│     └─────────────────────────┘
│
└── Program.cs                     [アプリ起動設定]
    ┌─────────────────────────┐
    │ builder.Services...      │ ← サービス登録
    │ app.UseStaticFiles()     │ ← 静的ファイル配信
    │ app.MapControllers()     │ ← ルーティング設定
    │ app.Run()                │ ← サーバー起動
    └─────────────────────────┘
```

## 図4: HTTPリクエスト/レスポンスの詳細

```
【リクエスト】
┌──────────────────────────────────────────────┐
│ GET /api/collections/search?searchText=電子部品 │
│ HTTP/1.1                                     │
│                                              │
│ Host: localhost:5000                         │
│ Accept: application/json                     │
│ User-Agent: Mozilla/5.0 ...                  │
└──────────────────────────────────────────────┘
        │
        │ インターネット/ネットワーク
        ↓
┌──────────────────────────────────────────────┐
│ ASP.NET Core Web Server                      │
│  ↓                                           │
│ ルーティング: /api/collections/search        │
│  ↓                                           │
│ コントローラー: CollectionsController.Search()│
│  ↓                                           │
│ サービス: CrecDataService.SearchCollections()│
│  ↓                                           │
│ ファイル読み込み & 検索処理                   │
└──────────────────────────────────────────────┘
        │
        │ 処理結果
        ↓
【レスポンス】
┌──────────────────────────────────────────────┐
│ HTTP/1.1 200 OK                              │
│ Content-Type: application/json               │
│ Content-Length: 1234                         │
│                                              │
│ {                                            │
│   "collections": [                           │
│     {                                        │
│       "collectionID": "SAMPLE001",           │
│       "collectionName": "電子部品サンプル",   │
│       "collectionCategory": "電子部品",       │
│       "collectionTag1": "Arduino",           │
│       "collectionCurrentInventory": 25,      │
│       ...                                    │
│     }                                        │
│   ],                                         │
│   "totalCount": 1,                           │
│   "page": 1,                                 │
│   "pageSize": 20                             │
│ }                                            │
└──────────────────────────────────────────────┘
```

## 図5: データ読み込みプロセス

```
Environment.CurrentDirectory = "/path/to/crec/data"

Directory.GetDirectories()
    │
    ├─→ SAMPLE001/
    │   ├── index.txt          ← これを読む
    │   │   ┌─────────────────────────────┐
    │   │   │ CollectionName,コレクション名│
    │   │   │ CollectionMC,管理コード        │
    │   │   │ CollectionCategory,コレクションのカテゴリ   │
    │   │   │ CollectionTag1,コレクションのタグ1       │
    │   │   │ ...                          │
    │   │   └─────────────────────────────┘
    │   └── [画像ファイル等]
    │
    ├─→ SAMPLE002/
    │   ├── index.txt
    │   └── ...
    │
    └─→ SAMPLE003/
        ├── index.txt
        └── ...

    ↓ 全フォルダをスキャン

┌──────────────────────────────┐
│ List<CollectionData>         │
│                              │
│ [0] SAMPLE001のデータ        │
│ [1] SAMPLE002のデータ        │
│ [2] SAMPLE003のデータ        │
│                              │
└──────────────────────────────┘
    │
    ↓ メモリ上に保存（キャッシュ）
    │
┌──────────────────────────────┐
│ _collectionsCache            │
│ (5分間有効)                   │
└──────────────────────────────┘
```

## 図6: CRECファイル構造の詳細

```
{dataPath}/                        ← プロジェクトデータのルート
│
├── {ProjectName}.crec             ← プロジェクト設定ファイル
│   ┌─────────────────────────────────────┐
│   │ ShowIDLabel,UUID,t           ← カスタムフィールド名
│   │ ShowMCLabel,管理コード,t
│   │ ShowCategoryLabel,カテゴリー,t
│   │ Tag1Name,メーカー,t          ← タグ名のカスタマイズ
│   │ Tag2Name,用途,t
│   │ Tag3Name,プロジェクト,t
│   │ ShowObjectNameLabel,部品名,t
│   │ projectlocation,{dataPath},t
│   └─────────────────────────────────────┘
│
└── {CollectionID}/                ← 各コレクションフォルダ
    │
    ├── index.txt                  ← コレクションメタデータ
    │   ┌─────────────────────────────────┐
    │   │ UUID                      ← フィールド名（固定）
    │   │ SAMPLE001                 ← ID値
    │   │ 名称                      ← フィールド名
    │   │ Arduino Uno Rev3          ← 名称値
    │   │ 管理コード
    │   │ MC-001
    │   │ カテゴリー
    │   │ マイコンボード
    │   │ タグ1
    │   │ Arduino
    │   │ タグ2
    │   │ Sample
    │   │ タグ3
    │   │ Component
    │   └─────────────────────────────────┘
    │
    ├── inventory.inv              ← 在庫管理データ（オプション）
    │
    ├── SystemData/                ← システムデータフォルダ
    │   └── Thumbnail.png          ← サムネイル画像
    │
    ├── pictures/                  ← 詳細画像フォルダ
    │   ├── image001.jpg           ← コレクションの画像
    │   ├── image002.jpg
    │   └── schematic.png
    │
    └── data/                      ← データファイルフォルダ
        ├── datasheet.pdf          ← 関連ドキュメント
        ├── manual.pdf
        └── specification.xlsx

【パス構造の重要ポイント】
- 画像: {dataPath}\{collectionId}\pictures\
- データファイル: {dataPath}\{collectionId}\data\
- サムネイル: {dataPath}\{collectionId}\SystemData\Thumbnail.png
```

## 図7: カスタムフィールドラベルの動作

```
┌─────────────────────┐
│ {ProjectName}.crec  │
│                     │
│ Tag1Name,メーカー,t  │ ← .crecファイルでタグ名定義
│ Tag2Name,用途,t      │
│ Tag3Name,プロジェクト,t│
└──────────┬──────────┘
           │
           ↓ ProjectSettingsService が読み込み
┌──────────────────────────────┐
│ ProjectSettingsController    │
│ GET /api/project-settings    │
└──────────┬───────────────────┘
           │
           ↓ JSON形式で返却
┌──────────────────────────────┐
│ {                            │
│   "tag1Name": "メーカー",     │
│   "tag2Name": "用途",         │
│   "tag3Name": "プロジェクト"  │
│ }                            │
└──────────┬───────────────────┘
           │
           ↓ フロントエンドが利用
┌──────────────────────────────┐
│ app.js                       │
│                              │
│ 検索ドロップダウン:           │
│  - 名称                       │
│  - メーカー     ← Tag1Name    │
│  - 用途         ← Tag2Name    │
│  - プロジェクト ← Tag3Name    │
│                              │
│ コレクションカード表示:       │
│  メーカー: Arduino           │
│  用途: Sample                │
│  プロジェクト: Component     │
└──────────────────────────────┘
```

## 図8: 画像カルーセル機能

```
┌────────────────────────────────────────┐
│ 詳細モーダル                            │
│                                        │
│  ┌────────────────────────────────┐   │
│  │                                 │   │
│  │      [画像表示エリア]            │   │
│  │                                 │   │
│  │      image001.jpg               │   │
│  │                                 │   │
│  └────────────────────────────────┘   │
│                                        │
│  ┌────────────────────────────────┐   │
│  │  ◀ Previous    1 / 3    Next ▶ │   │ ← ナビゲーション
│  └────────────────────────────────┘   │
│                                        │
│  image001.jpg                          │ ← ファイル名表示
│                                        │
│  【機能】                               │
│  ・ ◀ ▶ ボタンで画像切り替え           │
│  ・ ← → キーボードで画像切り替え       │
│  ・ 画像カウンター表示（現在位置/総数） │
│  ・ 最後の画像で次へ → 最初の画像へ    │
│  ・ 最初の画像で前へ → 最後の画像へ    │
└────────────────────────────────────────┘

【実装のポイント】
- Bootstrap modal の shown.bs.modal イベントで初期化
- 画像が存在する場合のみカルーセル機能を有効化
- 適切な null チェックでエラーを防止
```

## 図9: ファイル配信の仕組み

```
【画像ファイル配信】
GET /api/File/{collectionId}/{filename}
    │
    ↓ FileController
┌─────────────────────────────────────┐
│ 1. パス構築                          │
│    path = {dataPath}\{collectionId}\ │
│           pictures\{filename}        │
└─────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────┐
│ 2. セキュリティチェック              │
│    - ファイル名に ".." 含まれない？  │
│    - パスが正しいフォルダ内？        │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 3. MIMEタイプ判定                    │
│    .jpg  → image/jpeg                │
│    .png  → image/png                 │
│    .gif  → image/gif                 │
└─────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────┐
│ 4. PhysicalFile() でファイル配信     │
│    - ディスクから直接ストリーミング  │
│    - 効率的なバイナリデータ転送      │
└─────────────────────────────────────┘

【データファイル配信】
GET /api/File/data/{collectionId}/{filename}
    │
    ↓ FileController
┌─────────────────────────────────────┐
│ 1. パス構築                          │
│    path = {dataPath}\{collectionId}\ │
│           data\{filename}            │
└─────────────────────────────────────┘
    │
    ↓ (以下、画像ファイルと同様の処理)
```

## 図10: コントローラー構成

```
┌─────────────────────────────────────┐
│ ASP.NET Core Web API                │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ CollectionsController         │ │
│  │ /api/collections              │ │
│  │                               │ │
│  │ - GET /                       │ │ ← 全コレクション一覧
│  │ - GET /{id}                   │ │ ← 特定コレクション詳細
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ProjectSettingsController     │ │
│  │ /api/project-settings         │ │
│  │                               │ │
│  │ - GET /                       │ │ ← プロジェクト設定取得
│  │   （カスタムフィールドラベル） │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ FileController                │ │
│  │ /api/File                     │ │
│  │                               │ │
│  │ - GET /{id}/{file}            │ │ ← 画像ファイル配信
│  │ - GET /data/{id}/{file}       │ │ ← データファイル配信
│  │ - GET /thumbnail/{id}         │ │ ← サムネイル配信
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
         │
         ↓ 依存
┌─────────────────────────────────────┐
│ Services                            │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ CrecDataService               │ │
│  │                               │ │
│  │ - LoadAllCollections()        │ │
│  │ - LoadFileList()              │ │
│  │ - キャッシュ管理（5分）        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ProjectSettingsService        │ │
│  │                               │ │
│  │ - LoadProjectSettings()       │ │
│  │ - .crecファイルパース          │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 図11: セキュリティ対策

```
【安全なファイルアクセス】

リクエスト: GET /api/File/SAMPLE001/image.jpg
    │
    ↓ 検証ステップ
┌─────────────────────────────────────┐
│ 1. ファイル名チェック                │
│    ✓ ".." が含まれていないか？        │
│    ✓ "/" が含まれていないか？         │
│    ✓ "\\" が含まれていないか？        │
│    ✓ パストラバーサル攻撃を防止      │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 2. パス構築                          │
│    dataPath = "C:\CREC\data"         │
│    collectionPath = dataPath +       │
│                     "\SAMPLE001"     │
│    picturesPath = collectionPath +   │
│                   "\pictures"        │
│    filePath = picturesPath +         │
│               "\image.jpg"           │
│    = "C:\CREC\data\SAMPLE001\        │
│       pictures\image.jpg"            │
└─────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────┐
│ 3. パス検証                          │
│    filePath が正しいフォルダ内か？   │
│    ✓ はい → OK                       │
│    ✗ いいえ → 404 NotFound           │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 4. ファイル存在チェック              │
│    ✓ ファイルが存在する → OK         │
│    ✗ 存在しない → 404 NotFound       │
└─────────────────────────────────────┘
    │
    ↓ OK
┌─────────────────────────────────────┐
│ 5. ファイル配信                      │
│    PhysicalFile(filePath, mimeType)  │
│    - 直接ストリーミング配信          │
│    - 効率的なメモリ使用              │
└─────────────────────────────────────┘


【危険なアクセスの例】

リクエスト: GET /api/File/../../../etc/passwd
    │
    ↓
┌─────────────────────────────────────┐
│ ファイル名に ".." が含まれる         │
│ → BadRequest("Invalid file name")   │
│ → ブロック！                         │
└─────────────────────────────────────┘
    │
    ✗ アクセス拒否


【CORS設定】
┌─────────────────────────────────────┐
│ AllowAnyOrigin()                    │
│ - どのドメインからでもアクセス可能  │
│ - LAN内での複数端末アクセスに対応   │
│                                     │
│ AllowAnyMethod()                    │
│ - GET, POST等すべてのメソッドを許可 │
│                                     │
│ AllowAnyHeader()                    │
│ - すべてのHTTPヘッダーを許可        │
└─────────────────────────────────────┘
```

## 図12: キャッシュメカニズム

```
タイムライン:

00:00 ┌──────────────────────────────────┐
      │ 初回アクセス                      │
      │ ・ファイルから読み込み（遅い）    │
      │ ・キャッシュに保存                │
      │ ・lastUpdate = 00:00              │
      └──────────────────────────────────┘

00:01 ┌──────────────────────────────────┐
      │ 2回目のアクセス                   │
      │ ・キャッシュチェック: 有効期限内  │
      │ ・キャッシュから返す（速い！）    │
      └──────────────────────────────────┘

00:05 ┌──────────────────────────────────┐
      │ 5分後のアクセス                   │
      │ ・キャッシュチェック: 期限切れ    │
      │ ・ファイルから再読み込み          │
      │ ・キャッシュ更新                  │
      │ ・lastUpdate = 00:05              │
      └──────────────────────────────────┘


コードフロー:
┌────────────────────────────────────────┐
│ GetAllCollectionsAsync()               │
│   ↓                                    │
│ if (キャッシュあり && 有効期限内)      │
│   ├─ YES → キャッシュから返す (0.01秒)│
│   │                                    │
│   └─ NO  → ファイル読み込み (1秒)     │
│            ↓                           │
│            キャッシュに保存            │
│            ↓                           │
│            データを返す                │
└────────────────────────────────────────┘

メモリイメージ:
┌────────────────────────────────────────┐
│ CrecDataService クラス                 │
│                                        │
│ _collectionsCache: List<CollectionData>│
│   [SAMPLE001のデータ]                  │
│   [SAMPLE002のデータ]                  │
│   [SAMPLE003のデータ]                  │
│                                        │
│ _lastCacheUpdate: 2025-09-30 10:00:00 │
│                                        │
│ _cacheExpiry: 5分                      │
└────────────────────────────────────────┘
```

## 図8: 実行環境とポート

```
あなたのPC (Windows/Linux/Mac)
┌──────────────────────────────────────┐
│                                      │
│  ┌────────────────────────────┐    │
│  │ CREC_WebViewer.exe         │    │
│  │ (ASP.NET Core Server)      │    │
│  │                            │    │
│  │ ポート: 5000 (HTTP)        │←───┼─── ブラウザからアクセス
│  │ ポート: 5001 (HTTPS)       │    │    http://localhost:5000
│  └────────────────────────────┘    │
│                                      │
│  データフォルダ:                     │
│  C:\Users\...\CREC\Project\Data      │
│  (または Linux/Mac のパス)           │
│                                      │
└──────────────────────────────────────┘
         ↑
         │ ネットワーク経由でアクセス可能
         │ http://192.168.1.100:5000
         │
    ┌────┴────┐
    │ 他のPC  │
    │ (同じ   │
    │ ネット  │
    │ ワーク) │
    └─────────┘
```

---

これらの図を参考に、CREC Web Viewerの構造と動作を理解してください！
